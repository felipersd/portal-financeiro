# ----------------------------------------
# FASE 1: BUILD (Compila√ß√£o e Prepara√ß√£o)
# ----------------------------------------
FROM node:20-alpine AS builder

# Configura o ambiente de build
ENV NODE_ENV production
WORKDIR /app

# Copia os arquivos necess√°rios para instala√ß√£o
COPY package*.json ./
COPY prisma ./prisma/

# Instala as depend√™ncias (apenas as de produ√ß√£o)
RUN npm install --only=production

# Gera o cliente Prisma (Isso n√£o toca no banco, s√≥ cria o c√≥digo cliente)
RUN npx prisma generate

# ----------------------------------------
# FASE 2: RUNTIME (Imagem Final)
# ----------------------------------------
FROM node:20-alpine AS final

# Configura o ambiente de execu√ß√£o
WORKDIR /app
ENV NODE_ENV production

# Copia o c√≥digo fonte (o restante dos arquivos .js ou .ts compilados)
COPY . . 

# Copia os node_modules e o cliente Prisma gerados na fase de build
COPY --from=builder /app/node_modules ./node_modules

# O CMD √© o que o container ir√° executar quando for iniciado
# üö® IMPORTANTE: O comando de migra√ß√£o/push √© movido para o docker-compose!
# Aqui, apenas iniciamos o servidor.
CMD ["npm", "run", "start"]