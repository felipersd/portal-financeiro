services:
  db:
    image: postgres:15-alpine
    env_file:
      - .env
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: finance_db
    ports:
      - "${DB_PORT}:5432"
    networks:
      - app-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    image: node:20-alpine
    env_file:
      - .env
    working_dir: /app
    volumes:
      - ${PROJECT_ROOT}/server:/app
      - /app/node_modules
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - AUTH0_CALLBACK_URL=${AUTH0_CALLBACK_URL}
    ports:
      - "${API_PORT}:3000"
    networks:
      - app-network
    depends_on:
      - db
    command: sh -c "apk add --no-cache openssl && npm install && npx prisma generate && npx prisma db push --accept-data-loss && npm run dev"

  web:
    image: node:20-alpine
    env_file:
      - .env
    working_dir: /app
    volumes:
      - ${PROJECT_ROOT}:/app
      - /app/node_modules
    ports:
      - "${WEB_PORT}:5173"
    networks:
      - app-network
    environment:
      VITE_API_URL: http://api:3000
    depends_on:
      - api
    command: sh -c "npm install && npm run dev -- --host"

  cloudflared:
    image: cloudflare/cloudflared:latest
    env_file:
      - .env
    command: tunnel --no-autoupdate run --token eyJhIjoiNmNlNjQyMzkxYjFlMzcxYzkxNDI4NmJhN2I2Y2E3YzciLCJ0IjoiNzdlOGViMmQtZDA4NC00ZjBkLTgwODgtMTQyYzc3NmRmZDhjIiwicyI6IlpHVmxaalZsTWpFdE1qYzNZeTAwWTJJMUxXRTJNakF0TXpabU9URmhNVFUxTURWaSJ9
    networks:
      - app-network
    depends_on:
      - api
      - web

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    # Monitora apenas 'api' e 'web'. O Tunnel n√£o precisa ser monitorado.
    command: --interval 300 api web
    restart: always    

  # webhook:
  #   build: ./webhook
  #   container_name: webhook
  #   ports:
  #     - "7001:7001"
  #   environment:
  #     - WEBHOOK_SECRET=csetytpNVal0mHJGX2xA7D5LomCe6UKH
  #     - HOST_PROJECT_ROOT=c:/Users/felip/Documents/portal-financeiro
  #   networks:
  #     - app-network
  #   volumes:
  #     - .:/app
  #     - /var/run/docker.sock:/var/run/docker.sock # PERMITE CONTROLAR O DOCKER DO HOST

networks:
  app-network:


volumes:
  postgres_data:
