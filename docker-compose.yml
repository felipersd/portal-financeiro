services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: finance_db
    ports:
      - "${DB_PORT}:5432"
    networks:
      - app-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    image: felipersd/portal-financeiro-api:latest
    platform: linux/amd64
    container_name: portal_api
    networks:
      - app-network
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - AUTH0_CALLBACK_URL=${AUTH0_CALLBACK_URL}
      - PORT=3000
    ports:
      - "3000:3000"
    depends_on:
      - db
    entrypoint:
      - /bin/sh
      - -c
      - |
        sleep 5
        npm run prisma -- db push --accept-data-loss
        npm run start
    restart: always

  web:
    image: felipersd/portal-financeiro-web:latest
    platform: linux/amd64
    container_name: portal_web
    ports:
      - "80:80"
    networks:
      - app-network
    depends_on:
      - api
    restart: always

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token eyJhIjoiNmNlNjQyMzkxYjFlMzcxYzkxNDI4NmJhN2I2Y2E3YzciLCJ0IjoiNzdlOGViMmQtZDA4NC00ZjBkLTgwODgtMTQyYzc3NmRmZDhjIiwicyI6IlpHVmxaalZsTWpFdE1qYzNZeTAwWTJJMUxXRTJNakF0TXpabU9URmhNVFUxTURWaSJ9
    networks:
      - app-network
    depends_on:
      - api
      - web

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_API_VERSION=1.44
    # Monitora apenas 'api' e 'web'. O Tunnel n√£o precisa ser monitorado.
    command: --interval 30 portal_api portal_web
    restart: always
  # webhook:
  #   build: ./webhook
  #   container_name: webhook
  #   ports:
  #     - "7001:7001"
  #   environment:
  #     - WEBHOOK_SECRET=csetytpNVal0mHJGX2xA7D5LomCe6UKH
  #     - HOST_PROJECT_ROOT=c:/Users/felip/Documents/portal-financeiro
  #   networks:
  #     - app-network
  #   volumes:
  #     - .:/app
  #     - /var/run/docker.sock:/var/run/docker.sock # PERMITE CONTROLAR O DOCKER DO HOST

networks:
  app-network:


volumes:
  postgres_data:
