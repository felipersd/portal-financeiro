name: Rollback Helper

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to rollback'
        required: true
        type: choice
        options:
          - all
          - web
          - finance-service
          - identity-service
          - gateway
      version:
        description: 'Target Version Tag (e.g. v1.0.0)'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: web
            image: portal-financeiro-web
          - service: finance-service
            image: portal-financeiro-finance-service
          - service: identity-service
            image: portal-financeiro-identity-service
          - service: gateway
            image: portal-financeiro-gateway

    steps:
      - name: Login no Docker Hub
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == matrix.service }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Promote Version to Production
        if: ${{ github.event.inputs.service == 'all' || github.event.inputs.service == matrix.service }}
        run: |
          docker buildx imagetools create \
            -t ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}:production \
            ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image }}:${{ github.event.inputs.version }}
