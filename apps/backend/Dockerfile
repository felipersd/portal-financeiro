# ----------------------------------------
# FASE 1: BUILD (Compila√ß√£o e Prepara√ß√£o)
# ----------------------------------------
FROM node:20-alpine AS builder

# Configura o ambiente de build
ENV NODE_ENV production
WORKDIR /app

# Copia os arquivos necess√°rios para instala√ß√£o
COPY package*.json ./
COPY prisma ./prisma/

# Instala as depend√™ncias (apenas as de produ√ß√£o)
# Instala todas as depend√™ncias (incluindo devDependencies para o build)
RUN npm install --include=dev

# Gera o cliente Prisma
RUN npx prisma generate

# Copia o restante do c√≥digo fonte (src, tsconfig.json, etc)
COPY . .

# Compila o TypeScript
RUN npm run build

# ----------------------------------------
# FASE 2: RUNTIME (Imagem Final)
# ----------------------------------------
FROM node:20-alpine AS final

# Configura o ambiente de execu√ß√£o
WORKDIR /app
ENV NODE_ENV production

# Instala depend√™ncias do sistema necess√°rias (OpenSSL para o Prisma)
RUN apk add --no-cache openssl

# Copia o c√≥digo compilado da fase de build
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package*.json ./
COPY --from=builder /app/prisma ./prisma

# Instala apenas depend√™ncias de produ√ß√£o na imagem final
RUN npm install --only=production

# Copia o cliente Prisma gerado
COPY --from=builder /app/node_modules/@prisma ./node_modules/@prisma

# O CMD √© o que o container ir√° executar quando for iniciado
# üö® IMPORTANTE: O comando de migra√ß√£o/push √© movido para o docker-compose!
# Aqui, apenas iniciamos o servidor.
CMD ["npm", "run", "start"]